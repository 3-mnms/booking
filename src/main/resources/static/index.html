<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>공연 예매 대기열 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #status { margin-top: 20px; font-size: 1.2em; }
        #message { color: green; font-weight: bold; margin-top: 10px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: inline-block; width: 80px; }
        .input-group input { width: 200px; padding: 5px; }
    </style>
</head>
<body>
<h1>공연 예매 대기열 시스템</h1>

<div class="input-group">
    <label for="userIdInput">사용자 ID:</label>
    <input type="text" id="userIdInput" value="testuser1"> </div>

<button id="bookingButton">공연 예매하기</button>

<div id="status">현재 대기 순번: <span id="currentWaitingNumber">대기열에 없음</span></div>
<div id="message"></div>

<script>
    let stompClient = null;
    let currentUserId = null; // 현재 연결된 사용자 ID를 저장할 변수

    document.getElementById('bookingButton').addEventListener('click', function() {
        const userIdInput = document.getElementById('userIdInput').value;
        if (!userIdInput) {
            alert("사용자 ID를 입력해주세요.");
            return;
        }
        currentUserId = userIdInput; // 입력된 userId 저장

        // 기존 WebSocket 연결이 있다면 끊기 (새로운 userId로 재연결 위함)
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(function() {
                console.log("기존 WebSocket 연결 해제됨.");
                connectAndEnterQueue();
            });
        } else {
            connectAndEnterQueue();
        }
    });

    function connectAndEnterQueue() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 1. 대기 순번 알림 구독 (개인 채널)
            stompClient.subscribe('/user/queue/waiting-number', function (message) {
                const waitingNumberDto = JSON.parse(message.body);
                console.log("Received message:", waitingNumberDto);
                if (waitingNumberDto.waitingNumber === 0) {
                    document.getElementById('currentWaitingNumber').innerText = '즉시 입장 가능';
                    document.getElementById('message').innerText = '예매 페이지로 이동합니다!';
                    // TODO: 실제 예매 페이지로 리다이렉트 로직 추가
                } else if (waitingNumberDto.waitingNumber > 0) {
                    document.getElementById('currentWaitingNumber').innerText = waitingNumberDto.waitingNumber;
                    document.getElementById('message').innerText = '';
                } else {
                     document.getElementById('currentWaitingNumber').innerText = '대기열에 없음';
                     document.getElementById('message').innerText = '';
                }
            });

            // 2. 대기열 진입 요청 (API 호출)
            // index.html <script> 태그 안에서 fetch 부분
            fetch(`/api/booking/enter?userId=${currentUserId}`)
                .then(response => response.json()) // 항상 JSON으로 파싱 시도
                .then(data => {
                    // data는 이제 WaitingNumberDto 객체 형태가 됨
                    if (data.immediateEntry) { // immediateEntry 필드 확인
                        document.getElementById('currentWaitingNumber').innerText = '즉시 입장 가능';
                        document.getElementById('message').innerText = '예매 페이지로 이동합니다!';
                        // TODO: 실제 예매 페이지로 리다이렉트 로직 추가
                    } else if (data.waitingNumber > 0) {
                        document.getElementById('currentWaitingNumber').innerText = data.waitingNumber;
                        document.getElementById('message').innerText = '';
                    } else {
                        // 이 경우는 발생하지 않겠지만, 혹시 모를 상황 대비
                        document.getElementById('currentWaitingNumber').innerText = '대기열에 없음';
                        document.getElementById('message').innerText = '';
                    }
                })
                .catch(error => {
                    console.error('Error entering waiting queue:', error);
                    document.getElementById('currentWaitingNumber').innerText = '오류 발생';
                    document.getElementById('message').innerText = 'API 응답 처리 중 오류 발생';
                });

            // 3. WebSocket 구독 요청 (서버에 현재 userId 알려주기)
            // 이 부분에서 입력받은 currentUserId 사용
            stompClient.send(`/app/subscribe/waiting/${currentUserId}`, {}, JSON.stringify({ 'userId': currentUserId }));

        }, function (error) {
            console.error('STOMP Error: ' + error);
            document.getElementById('currentWaitingNumber').innerText = '연결 오류';
        });
    }

    // 페이지를 벗어날 때 대기열에서 사용자 제거 요청 (선택 사항)
    window.addEventListener('beforeunload', function() {
        if (currentUserId) {
            // 비동기 요청이므로 응답을 기다리지 않음
            fetch(`/api/booking/release/${currentUserId}`, { method: 'GET' })
                .then(response => {
                    if (!response.ok) {
                        console.error('Failed to release user on unload:', response.statusText);
                    }
                })
                .catch(error => console.error('Error releasing user on unload:', error));
        }
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }
    });
</script>
</body>
</html>